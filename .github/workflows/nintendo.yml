name: Nintendo Switch CI

on:
    push:
        branches: ["main"]
    pull_request:
    workflow_dispatch:

jobs:
    switch-build:
        runs-on: ubuntu-22.04
        container:
            image: devkitpro/devkita64 ## base on debian:buster-slim
        steps:
            - uses: actions/checkout@v3
              with:
                  fetch-depth: "0"

            - name: Setup Meson
              run: |
                  sudo apt-get update
                  sudo apt-get install python3 python3-pip -y
                  python3 -m pip install --upgrade pip
                  pip install meson

            - name: Setup ninja
              uses: abdes/gha-setup-ninja@master

            - name: Install Switch Ports for needed dependecies
              run: |
                  dkp-pacman -Syyu --noconfirm
                  dkp-pacman -S --needed --noconfirm  libnx switch-bzip2 switch-cmake switch-flac switch-freetype switch-libdrm_nouveau switch-libmodplug switch-libogg switch-libopus switch-libpng switch-libvorbis switch-libvorbisidec switch-mesa switch-mpg123 switch-opusfile switch-pkg-config switch-sdl2 switch-sdl2_mixer switch-sdl2_ttf switch-zlib

            - name: Build executable
              run: |
                  meson setup build
                  bash ./platforms/build-switch.sh

            - name: Upload artifacts
              uses: actions/upload-artifact@v3
              with:
                  name: oopetris.nro
                  path: build-switch/oopetris.nro
